# å‰ç«¯æ€§èƒ½ä¼˜åŒ–å®æˆ˜

## ä¸€ã€é—®é¢˜å¼•å…¥ï¼šé¦–å±åŠ è½½çš„ç”Ÿæ­»æ—¶é€Ÿ

### 1.1 çœŸå®æ¡ˆä¾‹ï¼šç”µå•†å¤§ä¿ƒé¡µé¢æ€§èƒ½å±æœº

```
åœºæ™¯ï¼š2024å¹´åŒ11å¤§ä¿ƒï¼Œå•†å“è¯¦æƒ…é¡µæ€§èƒ½å‘Šæ€¥
æ•°æ®ï¼šé¦–å±æ—¶é—´5.8ç§’ï¼Œè·³å‡ºç‡65%ï¼Œè½¬åŒ–ç‡ä¸‹é™40%

é—®é¢˜åˆ†æè¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šæ€§èƒ½è¯Šæ–­                                               â”‚
â”‚ - Lighthouseè¯„åˆ†ï¼š32/100ï¼ˆPoorï¼‰                             â”‚
â”‚ - FCPï¼ˆé¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼‰ï¼š2.1s                                  â”‚
â”‚ - LCPï¼ˆæœ€å¤§å†…å®¹ç»˜åˆ¶ï¼‰ï¼š5.8s                                  â”‚
â”‚ - TTIï¼ˆå¯äº¤äº’æ—¶é—´ï¼‰ï¼š8.3s                                    â”‚
â”‚ - CLSï¼ˆç´¯ç§¯å¸ƒå±€åç§»ï¼‰ï¼š0.35                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜¶æ®µ2ï¼šç“¶é¢ˆå®šä½                                               â”‚
â”‚ - èµ„æºä½“ç§¯ï¼šJS 2.8MBï¼ŒCSS 450KBï¼Œå›¾ç‰‡ 4.2MB                  â”‚
â”‚ - è¯·æ±‚æ•°é‡ï¼š127ä¸ªHTTPè¯·æ±‚                                    â”‚
â”‚ - é˜»å¡æ¸²æŸ“ï¼š3ä¸ªåŒæ­¥JSé˜»å¡äº†é¦–å±                              â”‚
â”‚ - æœªå‹ç¼©ï¼šGzipæœªå¯ç”¨ï¼Œèµ„æºä½“ç§¯è†¨èƒ€300%                       â”‚
â”‚ - å›¾ç‰‡é—®é¢˜ï¼šä½¿ç”¨PNGä»£æ›¿WebPï¼Œæ— å“åº”å¼å›¾ç‰‡                    â”‚
â”‚ - ç¼“å­˜ç¼ºå¤±ï¼šé™æ€èµ„æºç¼“å­˜ç­–ç•¥ä¸å½“                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜¶æ®µ3ï¼šä¼˜åŒ–å®æ–½                                               â”‚
â”‚ - ä»£ç åˆ†å‰²ï¼šè·¯ç”±çº§+ç»„ä»¶çº§æ‡’åŠ è½½                              â”‚
â”‚ - èµ„æºå‹ç¼©ï¼šå¯ç”¨Brotliï¼ŒJS/CSSå‹ç¼©ç‡70%                      â”‚
â”‚ - å›¾ç‰‡ä¼˜åŒ–ï¼šWebPæ ¼å¼ï¼Œå“åº”å¼å›¾ç‰‡ï¼Œæ‡’åŠ è½½                     â”‚
â”‚ - ç¼“å­˜ç­–ç•¥ï¼šé™æ€èµ„æº1å¹´ç¼“å­˜ï¼ŒAPIå“åº”ETag                     â”‚
â”‚ - é¢„åŠ è½½ï¼šå…³é”®èµ„æºpreloadï¼ŒDNSé¢„è§£æ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜¶æ®µ4ï¼šä¼˜åŒ–æ•ˆæœ                                               â”‚
â”‚ - Lighthouseè¯„åˆ†ï¼š32 â†’ 96                                    â”‚
â”‚ - FCPï¼š2.1s â†’ 0.8s                                           â”‚
â”‚ - LCPï¼š5.8s â†’ 1.2s                                           â”‚
â”‚ - TTIï¼š8.3s â†’ 2.1s                                           â”‚
â”‚ - CLSï¼š0.35 â†’ 0.02                                           â”‚
â”‚ - è·³å‡ºç‡ï¼š65% â†’ 35%                                          â”‚
â”‚ - è½¬åŒ–ç‡æå‡ï¼š58%                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¸å¿ƒæ•™è®­ï¼š
1. æ€§èƒ½ä¼˜åŒ–æ˜¯ç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦å…¨é“¾è·¯è€ƒè™‘
2. èµ„æºä½“ç§¯æ˜¯é¦–å±æ€§èƒ½çš„å…³é”®
3. ç¼“å­˜ç­–ç•¥èƒ½æ˜¾è‘—é™ä½é‡å¤è®¿é—®æˆæœ¬
4. å›¾ç‰‡ä¼˜åŒ–å¾€å¾€æ˜¯æŠ•å…¥äº§å‡ºæ¯”æœ€é«˜çš„ä¼˜åŒ–
```

### 1.2 æ ¸å¿ƒWebæŒ‡æ ‡ï¼ˆCore Web Vitalsï¼‰

```
Googleæ ¸å¿ƒWebæŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  LCP - Largest Contentful Paintï¼ˆæœ€å¤§å†…å®¹ç»˜åˆ¶ï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å®šä¹‰ï¼šè§†å£å†…æœ€å¤§å¯è§å†…å®¹å…ƒç´ çš„æ¸²æŸ“æ—¶é—´               â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç›®æ ‡å€¼ï¼š                                             â”‚   â”‚
â”‚  â”‚ ğŸŸ¢ Good: â‰¤ 2.5s                                     â”‚   â”‚
â”‚  â”‚ ğŸŸ¡ Needs Improvement: â‰¤ 4.0s                        â”‚   â”‚
â”‚  â”‚ ğŸ”´ Poor: > 4.0s                                     â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ å¸¸è§LCPå…ƒç´ ï¼š                                        â”‚   â”‚
â”‚  â”‚ - <img> å›¾ç‰‡                                         â”‚   â”‚
â”‚  â”‚ - <video> è§†é¢‘å°é¢                                   â”‚   â”‚
â”‚  â”‚ - èƒŒæ™¯å›¾ç‰‡ï¼ˆé€šè¿‡CSS url()åŠ è½½ï¼‰                      â”‚   â”‚
â”‚  â”‚ - å—çº§æ–‡æœ¬èŠ‚ç‚¹                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  FID - First Input Delayï¼ˆé¦–æ¬¡è¾“å…¥å»¶è¿Ÿï¼‰â†’ INPï¼ˆäº¤äº’åˆ°ç»˜åˆ¶ï¼‰ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å®šä¹‰ï¼šç”¨æˆ·é¦–æ¬¡äº¤äº’åˆ°æµè§ˆå™¨å“åº”çš„æ—¶é—´                   â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç›®æ ‡å€¼ï¼š                                             â”‚   â”‚
â”‚  â”‚ ğŸŸ¢ Good: â‰¤ 100ms                                    â”‚   â”‚
â”‚  â”‚ ğŸŸ¡ Needs Improvement: â‰¤ 300ms                       â”‚   â”‚
â”‚  â”‚ ğŸ”´ Poor: > 300ms                                    â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ä¼˜åŒ–æ–¹å‘ï¼š                                           â”‚   â”‚
â”‚  â”‚ - å‡å°‘ä¸»çº¿ç¨‹é˜»å¡                                     â”‚   â”‚
â”‚  â”‚ - ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½                                   â”‚   â”‚
â”‚  â”‚ - Web Workerså¤„ç†å¤æ‚è®¡ç®—                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  CLS - Cumulative Layout Shiftï¼ˆç´¯ç§¯å¸ƒå±€åç§»ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å®šä¹‰ï¼šé¡µé¢ç”Ÿå‘½å‘¨æœŸå†…å‘ç”Ÿçš„æ‰€æœ‰æ„å¤–å¸ƒå±€åç§»çš„æ€»å’Œ       â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç›®æ ‡å€¼ï¼š                                             â”‚   â”‚
â”‚  â”‚ ğŸŸ¢ Good: â‰¤ 0.1                                      â”‚   â”‚
â”‚  â”‚ ğŸŸ¡ Needs Improvement: â‰¤ 0.25                        â”‚   â”‚
â”‚  â”‚ ğŸ”´ Poor: > 0.25                                     â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ å¸¸è§åŸå› ï¼š                                           â”‚   â”‚
â”‚  â”‚ - å›¾ç‰‡/è§†é¢‘æ— å°ºå¯¸å±æ€§                                â”‚   â”‚
â”‚  â”‚ - å­—ä½“åŠ è½½å¯¼è‡´FOIT/FOUT                              â”‚   â”‚
â”‚  â”‚ - åŠ¨æ€æ’å…¥å†…å®¹                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  TTFB - Time to First Byteï¼ˆé¦–å­—èŠ‚æ—¶é—´ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å®šä¹‰ï¼šæµè§ˆå™¨æ”¶åˆ°å“åº”ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´                   â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ ç›®æ ‡å€¼ï¼š                                             â”‚   â”‚
â”‚  â”‚ ğŸŸ¢ Good: â‰¤ 600ms                                    â”‚   â”‚
â”‚  â”‚ ğŸŸ¡ Needs Improvement: â‰¤ 800ms                       â”‚   â”‚
â”‚  â”‚ ğŸ”´ Poor: > 800ms                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€èµ„æºåŠ è½½ä¼˜åŒ–

### 2.1 å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–

```
å…³é”®æ¸²æŸ“è·¯å¾„ï¼ˆCritical Rendering Pathï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  æµè§ˆå™¨æ¸²æŸ“æµç¨‹ï¼š                                             â”‚
â”‚                                                              â”‚
â”‚  HTML â”€â”€â–¶ DOMæ ‘ â”€â”€â”                                          â”‚
â”‚                   â”œâ”€â”€â–¶ æ¸²æŸ“æ ‘ â”€â”€â–¶ å¸ƒå±€ â”€â”€â–¶ ç»˜åˆ¶ â”€â”€â–¶ åˆæˆ   â”‚
â”‚  CSS â”€â”€â”€â–¶ CSSOM â”€â”€â”˜                                          â”‚
â”‚                                                              â”‚
â”‚  é˜»å¡æ¸²æŸ“çš„èµ„æºï¼š                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CSSï¼ˆRender Blockingï¼‰                               â”‚   â”‚
â”‚  â”‚ - æµè§ˆå™¨ä¼šç­‰å¾…æ‰€æœ‰CSSåŠ è½½å®Œæˆæ‰æ¸²æŸ“                  â”‚   â”‚
â”‚  â”‚ - è§£å†³æ–¹æ¡ˆï¼š                                         â”‚   â”‚
â”‚  â”‚   1. å†…è”å…³é”®CSSï¼ˆCritical CSSï¼‰                     â”‚   â”‚
â”‚  â”‚   2. å¼‚æ­¥åŠ è½½éå…³é”®CSS                               â”‚   â”‚
â”‚  â”‚   3. ä½¿ç”¨mediaæŸ¥è¯¢å‡å°‘é˜»å¡                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ JavaScriptï¼ˆParser Blockingï¼‰                        â”‚   â”‚
â”‚  â”‚ - åŒæ­¥JSä¼šé˜»å¡HTMLè§£æ                               â”‚   â”‚
â”‚  â”‚ - è§£å†³æ–¹æ¡ˆï¼š                                         â”‚   â”‚
â”‚  â”‚   1. asyncå±æ€§ï¼ˆå¼‚æ­¥ä¸‹è½½ï¼Œä¸‹è½½å®Œç«‹å³æ‰§è¡Œï¼‰           â”‚   â”‚
â”‚  â”‚   2. deferå±æ€§ï¼ˆå¼‚æ­¥ä¸‹è½½ï¼ŒDOMè§£æåæ‰§è¡Œï¼‰            â”‚   â”‚
â”‚  â”‚   3. ä»£ç åˆ†å‰²ï¼Œå»¶è¿ŸåŠ è½½éå…³é”®JS                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Vue3æ€§èƒ½ä¼˜åŒ–å®æˆ˜

```vue
<!-- Vue3æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹ï¼šäº§å“è¯¦æƒ…é¡µ -->
<template>
  <div class="product-page">
    <!-- 1. éª¨æ¶å±ä¼˜åŒ–é¦–å±ä½“éªŒ -->
    <ProductSkeleton v-if="loading" />
    
    <template v-else>
      <!-- 2. å…³é”®å†…å®¹ä¼˜å…ˆæ¸²æŸ“ -->
      <ProductHeader 
        :product="product" 
        @add-to-cart="handleAddToCart"
      />
      
      <!-- 3. å¼‚æ­¥åŠ è½½éå…³é”®ç»„ä»¶ -->
      <Suspense>
        <template #default>
          <ProductGallery :images="product.images" />
        </template>
        <template #fallback>
          <ImageSkeleton />
        </template>
      </Suspense>
      
      <!-- 4. æ‡’åŠ è½½éé¦–å±å†…å®¹ -->
      <LazyProductSpecs :specs="product.specs" />
      <LazyProductReviews :product-id="product.id" />
      <LazyRelatedProducts :category="product.category" />
    </template>
  </div>
</template>

<script setup>
import { defineAsyncComponent, ref, onMounted } from 'vue';
import { useIntersectionObserver } from '@vueuse/core';

// åŒæ­¥åŠ è½½å…³é”®ç»„ä»¶
import ProductHeader from './components/ProductHeader.vue';
import ProductSkeleton from './components/ProductSkeleton.vue';

// å¼‚æ­¥åŠ è½½éå…³é”®ç»„ä»¶ï¼ˆè‡ªåŠ¨ä»£ç åˆ†å‰²ï¼‰
const ProductGallery = defineAsyncComponent(() => 
  import('./components/ProductGallery.vue')
);

// æ‡’åŠ è½½éé¦–å±ç»„ä»¶
const LazyProductSpecs = defineAsyncComponent(() => 
  import('./components/ProductSpecs.vue')
);
const LazyProductReviews = defineAsyncComponent(() => 
  import('./components/ProductReviews.vue')
);
const LazyRelatedProducts = defineAsyncComponent(() => 
  import('./components/RelatedProducts.vue')
);

const loading = ref(true);
const product = ref(null);

// é¢„åŠ è½½å…³é”®æ•°æ®
onMounted(async () => {
  // ä½¿ç”¨Promise.raceç¡®ä¿é¦–å±æ•°æ®å¿«é€Ÿè¿”å›
  const timeout = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('Timeout')), 3000)
  );
  
  try {
    product.value = await Promise.race([
      fetchProduct(),
      timeout
    ]);
  } catch (e) {
    // é™çº§å¤„ç†ï¼šæ˜¾ç¤ºç®€åŒ–ç‰ˆé¡µé¢
    product.value = await fetchProductMinimal();
  } finally {
    loading.value = false;
  }
});

// å›¾ç‰‡æ‡’åŠ è½½æŒ‡ä»¤
const vLazy = {
  mounted(el, binding) {
    const { stop } = useIntersectionObserver(
      el,
      ([{ isIntersecting }]) => {
        if (isIntersecting) {
          el.src = binding.value;
          stop();
        }
      },
      { rootMargin: '50px' }
    );
  }
};
</script>

<style>
/* 5. å…³é”®CSSå†…è” */
/* è¿™äº›æ ·å¼åº”è¯¥å†…è”åˆ°HTMLä¸­ */
.product-page {
  contain: layout style paint;
}

.product-header {
  content-visibility: auto;
  contain-intrinsic-size: 0 500px;
}

/* 6. ä½¿ç”¨CSS Containmentä¼˜åŒ–æ¸²æŸ“ */
.product-card {
  contain: layout style;
}

/* 7. will-changeä¼˜åŒ–åŠ¨ç”» */
.product-image:hover {
  will-change: transform;
  transform: scale(1.05);
}
</style>
```

### 2.3 èµ„æºé¢„åŠ è½½ç­–ç•¥

```html
<!-- index.html èµ„æºé¢„åŠ è½½é…ç½® -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- 1. DNSé¢„è§£æ - æå‰è§£æå¯èƒ½è®¿é—®çš„åŸŸå -->
  <link rel="dns-prefetch" href="//cdn.example.com">
  <link rel="dns-prefetch" href="//api.example.com">
  <link rel="dns-prefetch" href="//img.example.com">
  
  <!-- 2. é¢„è¿æ¥ - æå‰å»ºç«‹TCPè¿æ¥ -->
  <link rel="preconnect" href="https://api.example.com" crossorigin>
  <link rel="preconnect" href="https://cdn.example.com" crossorigin>
  
  <!-- 3. é¢„åŠ è½½å…³é”®èµ„æº -->
  <!-- å…³é”®CSS -->
  <link rel="preload" href="/css/critical.css" as="style">
  <!-- å…³é”®å­—ä½“ -->
  <link rel="preload" href="/fonts/main.woff2" as="font" type="font/woff2" crossorigin>
  <!-- é¦–å±å›¾ç‰‡ -->
  <link rel="preload" href="/images/hero.webp" as="image" type="image/webp">
  <!-- å…³é”®JSæ¨¡å— -->
  <link rel="modulepreload" href="/js/app.js">
  
  <!-- 4. é¢„è·å–ä¸‹ä¸€é¡µèµ„æº -->
  <link rel="prefetch" href="/js/product-page.js">
  <link rel="prefetch" href="/css/product-page.css">
  
  <!-- 5. é¢„æ¸²æŸ“ï¼ˆå¯¹ç¡®å®šä¼šè®¿é—®çš„é¡µé¢ï¼‰ -->
  <link rel="prerender" href="/product-list">
  
  <!-- å†…è”å…³é”®CSS -->
  <style>
    /* Critical CSS - é¦–å±å¿…éœ€æ ·å¼ */
    body { margin: 0; font-family: system-ui, sans-serif; }
    .header { height: 60px; background: #fff; }
    .hero { min-height: 400px; }
    /* ... */
  </style>
  
  <!-- å¼‚æ­¥åŠ è½½éå…³é”®CSS -->
  <link rel="preload" href="/css/non-critical.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/css/non-critical.css"></noscript>
</head>
<body>
  <div id="app"></div>
  
  <!-- å¼‚æ­¥åŠ è½½ä¸»JS -->
  <script type="module" src="/js/app.js"></script>
  
  <!-- é¢„åŠ è½½å…³é”®æ•°æ® -->
  <link rel="preload" href="/api/config" as="fetch" crossorigin>
</body>
</html>
```

## ä¸‰ã€å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥

### 3.1 ç°ä»£å›¾ç‰‡æ ¼å¼ä¸å“åº”å¼å›¾ç‰‡

```vue
<!-- Vue3å“åº”å¼å›¾ç‰‡ç»„ä»¶ -->
<template>
  <picture class="responsive-image">
    <!-- 1. AVIFæ ¼å¼ï¼ˆæœ€ä½³å‹ç¼©ç‡ï¼Œæµè§ˆå™¨æ”¯æŒé€æ­¥å®Œå–„ï¼‰ -->
    <source
      :srcset="avifSrcset"
      type="image/avif"
      sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 33vw"
    >
    
    <!-- 2. WebPæ ¼å¼ï¼ˆå¹¿æ³›æ”¯æŒï¼Œæ¯”JPEGå°25-35%ï¼‰ -->
    <source
      :srcset="webpSrcset"
      type="image/webp"
      sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 33vw"
    >
    
    <!-- 3. JPEGå›é€€ -->
    <img
      :src="fallbackSrc"
      :srcset="jpegSrcset"
      :alt="alt"
      :width="width"
      :height="height"
      loading="lazy"
      decoding="async"
      @load="handleLoad"
    >
  </picture>
</template>

<script setup>
import { computed } from 'vue';

const props = defineProps({
  src: String,
  alt: String,
  width: Number,
  height: Number,
  sizes: {
    type: Array,
    default: () => [320, 640, 960, 1280, 1920]
  }
});

// ç”Ÿæˆå“åº”å¼srcset
const generateSrcset = (format) => {
  return props.sizes
    .map(size => `/images/${props.src}-${size}w.${format} ${size}w`)
    .join(', ');
};

const avifSrcset = computed(() => generateSrcset('avif'));
const webpSrcset = computed(() => generateSrcset('webp'));
const jpegSrcset = computed(() => generateSrcset('jpg'));
const fallbackSrc = computed(() => `/images/${props.src}-640w.jpg`);

const handleLoad = () => {
  // å›¾ç‰‡åŠ è½½å®Œæˆåçš„å¤„ç†
  console.log('Image loaded:', props.src);
};
</script>

<style scoped>
.responsive-image img {
  width: 100%;
  height: auto;
  /* é˜²æ­¢å¸ƒå±€åç§» */
  aspect-ratio: attr(width) / attr(height);
}
</style>
```

### 3.2 å›¾ç‰‡æ‡’åŠ è½½ä¸å ä½

```vue
<!-- æ™ºèƒ½å›¾ç‰‡æ‡’åŠ è½½ç»„ä»¶ -->
<template>
  <div 
    class="lazy-image-container"
    :style="{ aspectRatio: aspectRatio }"
  >
    <!-- 1. ä½è´¨é‡å ä½å›¾ï¼ˆLQIP - Low Quality Image Placeholderï¼‰ -->
    <img
      v-if="!loaded"
      :src="placeholderSrc"
      class="placeholder"
      :alt="alt"
    >
    
    <!-- 2. å®é™…å›¾ç‰‡ -->
    <img
      ref="imageRef"
      :src="currentSrc"
      :alt="alt"
      :class="['lazy-image', { loaded }]"
      @load="onLoad"
    >
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useIntersectionObserver } from '@vueuse/core';

const props = defineProps({
  src: String,
  placeholder: String,  // Base64ç¼–ç çš„æ¨¡ç³Šå›¾
  alt: String,
  width: Number,
  height: Number,
  threshold: { type: Number, default: 0.1 }
});

const imageRef = ref(null);
const loaded = ref(false);
const inView = ref(false);

const aspectRatio = computed(() => `${props.width} / ${props.height}`);
const placeholderSrc = computed(() => props.placeholder || generatePlaceholder());
const currentSrc = computed(() => inView.value ? props.src : '');

// ç”ŸæˆSVGå ä½å›¾
const generatePlaceholder = () => {
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" 
    viewBox="0 0 ${props.width} ${props.height}">
    <rect fill="#f0f0f0" width="100%" height="100%"/>
  </svg>`;
  return `data:image/svg+xml,${encodeURIComponent(svg)}`;
};

// ä½¿ç”¨Intersection Observerå®ç°æ‡’åŠ è½½
onMounted(() => {
  const { stop } = useIntersectionObserver(
    imageRef,
    ([{ isIntersecting }]) => {
      if (isIntersecting) {
        inView.value = true;
        stop();
      }
    },
    { threshold: props.threshold, rootMargin: '50px' }
  );
});

const onLoad = () => {
  loaded.value = true;
};
</script>

<style scoped>
.lazy-image-container {
  position: relative;
  overflow: hidden;
  background: #f0f0f0;
}

.placeholder {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(10px);
  transform: scale(1.1);
}

.lazy-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.lazy-image.loaded {
  opacity: 1;
}
</style>
```

### 3.3 å›¾ç‰‡CDNä¸è‡ªåŠ¨ä¼˜åŒ–

```javascript
/**
 * å›¾ç‰‡URLæ„å»ºå·¥å…·
 * æ”¯æŒå¤šç§CDNçš„å›¾ç‰‡ä¼˜åŒ–å‚æ•°
 */
export class ImageOptimizer {
  constructor(config = {}) {
    this.cdn = config.cdn || 'cloudinary'; // cloudinary, imgix, aliyun
    this.baseUrl = config.baseUrl || '';
  }

  /**
   * æ„å»ºä¼˜åŒ–åçš„å›¾ç‰‡URL
   */
  buildUrl(src, options = {}) {
    const {
      width,
      height,
      format = 'auto',  // auto, webp, avif, jpg
      quality = 80,
      fit = 'cover',    // cover, contain, fill, inside, outside
      loading = 'lazy'
    } = options;

    switch (this.cdn) {
      case 'cloudinary':
        return this.buildCloudinaryUrl(src, { width, height, format, quality, fit });
      case 'imgix':
        return this.buildImgixUrl(src, { width, height, format, quality, fit });
      case 'aliyun':
        return this.buildAliyunUrl(src, { width, height, format, quality, fit });
      default:
        return src;
    }
  }

  buildCloudinaryUrl(src, options) {
    const { width, height, format, quality, fit } = options;
    const transforms = [
      `q_${quality}`,
      `f_${format}`,
      width && `w_${width}`,
      height && `h_${height}`,
      fit && `c_${fit}`
    ].filter(Boolean).join(',');

    return `${this.baseUrl}/image/upload/${transforms}/${src}`;
  }

  buildImgixUrl(src, options) {
    const { width, height, format, quality, fit } = options;
    const params = new URLSearchParams({
      q: quality,
      fm: format,
      ...(width && { w: width }),
      ...(height && { h: height }),
      ...(fit && { fit })
    });

    return `${this.baseUrl}/${src}?${params.toString()}`;
  }

  buildAliyunUrl(src, options) {
    const { width, height, format, quality } = options;
    const params = new URLSearchParams({
      'x-oss-process': `image/resize${width ? `,w_${width}` : ''}${height ? `,h_${height}` : ''}/quality,q_${quality}/format,${format}`
    });

    return `${this.baseUrl}/${src}?${params.toString()}`;
  }

  /**
   * ç”Ÿæˆå“åº”å¼srcset
   */
  generateSrcset(src, sizes, options = {}) {
    return sizes
      .map(size => {
        const url = this.buildUrl(src, { ...options, width: size });
        return `${url} ${size}w`;
      })
      .join(', ');
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const optimizer = new ImageOptimizer({
  cdn: 'cloudinary',
  baseUrl: 'https://res.cloudinary.com/demo'
});

// ç”Ÿæˆå“åº”å¼å›¾ç‰‡URL
const srcset = optimizer.generateSrcset(
  'sample.jpg',
  [320, 640, 960, 1280],
  { format: 'webp', quality: 85 }
);

console.log(srcset);
// è¾“å‡º: https://.../w_320,q_85,f_webp/sample.jpg 320w, https://.../w_640,q_85,f_webp/sample.jpg 640w, ...
```

## å››ã€ä»£ç ä¼˜åŒ–ä¸åˆ†å‰²

### 4.1 Webpack/Viteä»£ç åˆ†å‰²

```javascript
// vite.config.js - Viteä»£ç åˆ†å‰²é…ç½®
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';
import { visualizer } from 'rollup-plugin-visualizer';

export default defineConfig({
  plugins: [
    vue(),
    visualizer({ open: true })  // æ‰“åŒ…åˆ†æ
  ],
  
  build: {
    // ä»£ç åˆ†å‰²ç­–ç•¥
    rollupOptions: {
      output: {
        // 1. æ‰‹åŠ¨ä»£ç åˆ†å‰²
        manualChunks: {
          // ç¬¬ä¸‰æ–¹åº“åˆ†ç¦»
          'vendor': [
            'vue',
            'vue-router',
            'pinia'
          ],
          'ui': [
            'element-plus',
            '@element-plus/icons-vue'
          ],
          'utils': [
            'lodash-es',
            'dayjs',
            'axios'
          ]
        },
        
        // 2. åŠ¨æ€å¯¼å…¥è‡ªåŠ¨åˆ†å‰²
        // ç»„ä»¶çº§æ‡’åŠ è½½ä¼šè‡ªåŠ¨åˆ†å‰²
        
        // 3. è¾“å‡ºæ–‡ä»¶åç­–ç•¥
        entryFileNames: 'js/[name]-[hash].js',
        chunkFileNames: 'js/[name]-[hash].js',
        assetFileNames: (assetInfo) => {
          const info = assetInfo.name.split('.');
          const ext = info[info.length - 1];
          
          if (/\.(png|jpe?g|gif|svg|webp|avif)$/i.test(assetInfo.name)) {
            return 'images/[name]-[hash][extname]';
          }
          if (/\.(css)$/i.test(assetInfo.name)) {
            return 'css/[name]-[hash][extname]';
          }
          if (/\.(woff2?|ttf|otf|eot)$/i.test(assetInfo.name)) {
            return 'fonts/[name]-[hash][extname]';
          }
          return 'assets/[name]-[hash][extname]';
        }
      }
    },
    
    // 4. å‹ç¼©é…ç½®
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
        pure_funcs: ['console.log']
      }
    },
    
    // 5. èµ„æºå†…è”é˜ˆå€¼
    assetsInlineLimit: 4096,  // 4KBä»¥ä¸‹å†…è”ä¸ºbase64
    
    // 6. CSSä»£ç åˆ†å‰²
    cssCodeSplit: true,
    
    // 7. æºç æ˜ å°„ï¼ˆç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
    sourcemap: false
  },
  
  // ä¾èµ–é¢„æ„å»ºä¼˜åŒ–
  optimizeDeps: {
    include: [
      'vue',
      'vue-router',
      'pinia',
      'element-plus',
      'lodash-es'
    ],
    exclude: ['@your-org/large-lib']  // æ’é™¤ä¸éœ€è¦é¢„æ„å»ºçš„åŒ…
  }
});
```

### 4.2 è·¯ç”±çº§ä¸ç»„ä»¶çº§æ‡’åŠ è½½

```javascript
// router/index.js - Vue Routeræ‡’åŠ è½½
import { createRouter, createWebHistory } from 'vue-router';

const routes = [
  {
    path: '/',
    name: 'Home',
    component: () => import(/* webpackChunkName: "home" */ '../views/Home.vue')
  },
  {
    path: '/product/:id',
    name: 'Product',
    component: () => import(/* webpackChunkName: "product" */ '../views/Product.vue'),
    // é¢„åŠ è½½ç­–ç•¥
    meta: {
      prefetch: true
    }
  },
  {
    path: '/cart',
    name: 'Cart',
    component: () => import(/* webpackChunkName: "cart" */ '../views/Cart.vue')
  },
  {
    path: '/user',
    name: 'User',
    component: () => import(/* webpackChunkName: "user" */ '../views/User.vue'),
    children: [
      {
        path: 'orders',
        component: () => import(/* webpackChunkName: "user-orders" */ '../views/user/Orders.vue')
      },
      {
        path: 'settings',
        component: () => import(/* webpackChunkName: "user-settings" */ '../views/user/Settings.vue')
      }
    ]
  }
];

const router = createRouter({
  history: createWebHistory(),
  routes
});

// æ™ºèƒ½é¢„åŠ è½½
router.beforeEach((to, from, next) => {
  // é¢„åŠ è½½ä¸‹ä¸€é¡µå¯èƒ½è®¿é—®çš„è·¯ç”±
  const matched = to.matched;
  matched.forEach(route => {
    if (route.meta.prefetch) {
      const component = route.component;
      if (typeof component === 'function') {
        // è§¦å‘ç»„ä»¶åŠ è½½
        component();
      }
    }
  });
  next();
});

export default router;
```

```vue
<!-- ç»„ä»¶çº§æ‡’åŠ è½½ç¤ºä¾‹ -->
<template>
  <div class="dashboard">
    <!-- å›¾è¡¨ç»„ä»¶ - é‡é‡çº§ï¼Œéœ€è¦æ‡’åŠ è½½ -->
    <Suspense>
      <template #default>
        <ChartComponent :data="chartData" />
      </template>
      <template #fallback>
        <ChartSkeleton />
      </template>
    </Suspense>
    
    <!-- åœ°å›¾ç»„ä»¶ - ä»…åœ¨éœ€è¦æ—¶åŠ è½½ -->
    <LazyMap v-if="showMap" :locations="locations" />
    
    <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ - å»¶è¿ŸåŠ è½½ -->
    <LazyEditor v-if="isEditing" v-model="content" />
  </div>
</template>

<script setup>
import { defineAsyncComponent, ref, onMounted } from 'vue';

// åŒæ­¥åŠ è½½è½»é‡çº§ç»„ä»¶
import ChartSkeleton from './components/ChartSkeleton.vue';

// å¼‚æ­¥åŠ è½½é‡é‡çº§ç»„ä»¶
const ChartComponent = defineAsyncComponent({
  loader: () => import('./components/ChartComponent.vue'),
  loadingComponent: ChartSkeleton,
  delay: 200,  // å»¶è¿Ÿæ˜¾ç¤ºloadingçŠ¶æ€
  timeout: 3000  // è¶…æ—¶æ—¶é—´
});

// ä½¿ç”¨é­”æ³•æ³¨é‡Šè¿›è¡Œä»£ç åˆ†å‰²
const LazyMap = defineAsyncComponent(() => 
  import(/* webpackChunkName: "map" */ './components/Map.vue')
);

const LazyEditor = defineAsyncComponent(() => 
  import(/* webpackChunkName: "editor" */ './components/RichEditor.vue')
);

// ä½¿ç”¨requestIdleCallbackå»¶è¿ŸåŠ è½½éå…³é”®ç»„ä»¶
const showMap = ref(false);
const isEditing = ref(false);

onMounted(() => {
  // åœ¨æµè§ˆå™¨ç©ºé—²æ—¶åŠ è½½åœ°å›¾ç»„ä»¶
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      showMap.value = true;
    }, { timeout: 2000 });
  } else {
    setTimeout(() => {
      showMap.value = true;
    }, 2000);
  }
});
</script>
```

## äº”ã€ç¼“å­˜ç­–ç•¥ä¸Service Worker

### 5.1 HTTPç¼“å­˜ç­–ç•¥

```nginx
# Nginxç¼“å­˜é…ç½®
server {
    listen 80;
    server_name example.com;
    root /var/www/html;
    
    # 1. å¼ºç¼“å­˜ - é•¿æœŸä¸å˜çš„èµ„æº
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        
        # å¯ç”¨gzip/brotliå‹ç¼©
        gzip on;
        gzip_types text/css application/javascript image/svg+xml;
    }
    
    # 2. åå•†ç¼“å­˜ - å¯èƒ½å˜åŒ–çš„èµ„æº
    location ~* \.(html|json|xml)$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        add_header ETag $request_filename;
    }
    
    # 3. APIå“åº”ç¼“å­˜
    location /api/ {
        proxy_pass http://backend;
        
        # æ ¹æ®å“åº”ç±»å‹è®¾ç½®ç¼“å­˜
        location ~* \.(json)$ {
            expires 5m;
            add_header Cache-Control "public, must-revalidate";
        }
    }
    
    # 4. ä¸ç¼“å­˜çš„èµ„æº
    location ~* \.(manifest|appcache)$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
}
```

### 5.2 Service Workerç¼“å­˜ç­–ç•¥

```javascript
// sw.js - Service Workerç¼“å­˜ç­–ç•¥
const CACHE_NAME = 'app-v1';
const STATIC_ASSETS = [
  '/',
  '/index.html',
  '/css/critical.css',
  '/js/app.js',
  '/offline.html'
];

// å®‰è£…ï¼šé¢„ç¼“å­˜å…³é”®èµ„æº
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('Pre-caching static assets');
        return cache.addAll(STATIC_ASSETS);
      })
      .then(() => self.skipWaiting())
  );
});

// æ¿€æ´»ï¼šæ¸…ç†æ—§ç¼“å­˜
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name !== CACHE_NAME)
          .map((name) => caches.delete(name))
      );
    }).then(() => self.clients.claim())
  );
});

// æ‹¦æˆªè¯·æ±‚
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);
  
  // 1. é™æ€èµ„æºï¼šCache First
  if (isStaticAsset(url)) {
    event.respondWith(cacheFirst(request));
    return;
  }
  
  // 2. APIè¯·æ±‚ï¼šNetwork First
  if (isAPIRequest(url)) {
    event.respondWith(networkFirst(request));
    return;
  }
  
  // 3. é¡µé¢è¯·æ±‚ï¼šStale While Revalidate
  if (isPageRequest(url)) {
    event.respondWith(staleWhileRevalidate(request));
    return;
  }
  
  // é»˜è®¤ï¼šç½‘ç»œè¯·æ±‚
  event.respondWith(fetch(request));
});

// ç¼“å­˜ç­–ç•¥å®ç°

// Cache Firstï¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­å†è¯·æ±‚ç½‘ç»œ
async function cacheFirst(request) {
  const cache = await caches.open(CACHE_NAME);
  const cached = await cache.match(request);
  
  if (cached) {
    return cached;
  }
  
  try {
    const response = await fetch(request);
    cache.put(request, response.clone());
    return response;
  } catch (error) {
    return new Response('Offline', { status: 503 });
  }
}

// Network Firstï¼šä¼˜å…ˆè¯·æ±‚ç½‘ç»œï¼Œå¤±è´¥æ—¶å›é€€åˆ°ç¼“å­˜
async function networkFirst(request) {
  const cache = await caches.open(CACHE_NAME);
  
  try {
    const networkResponse = await fetch(request);
    cache.put(request, networkResponse.clone());
    return networkResponse;
  } catch (error) {
    const cached = await cache.match(request);
    if (cached) {
      return cached;
    }
    throw error;
  }
}

// Stale While Revalidateï¼šç«‹å³è¿”å›ç¼“å­˜ï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜
async function staleWhileRevalidate(request) {
  const cache = await caches.open(CACHE_NAME);
  const cached = await cache.match(request);
  
  const networkPromise = fetch(request)
    .then((response) => {
      cache.put(request, response.clone());
      return response;
    })
    .catch(() => null);
  
  return cached || networkPromise;
}

// è¾…åŠ©å‡½æ•°
function isStaticAsset(url) {
  return /\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$/.test(url.pathname);
}

function isAPIRequest(url) {
  return url.pathname.startsWith('/api/');
}

function isPageRequest(url) {
  return url.pathname === '/' || /\.(html)$/.test(url.pathname);
}

// åå°åŒæ­¥
self.addEventListener('sync', (event) => {
  if (event.tag === 'sync-cart') {
    event.waitUntil(syncCartData());
  }
});

// æ¨é€é€šçŸ¥
self.addEventListener('push', (event) => {
  const data = event.data.json();
  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: '/icon.png',
      badge: '/badge.png'
    })
  );
});
```

## å…­ã€æ€§èƒ½ç›‘æ§ä¸åˆ†æ

### 6.1 Web Vitalsç›‘æ§

```javascript
// utils/performance.js - æ€§èƒ½ç›‘æ§å·¥å…·
import { getCLS, getFID, getFCP, getLCP, getTTFB, getINP } from 'web-vitals';

/**
 * åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
 */
export function initPerformanceMonitoring() {
  // æ ¸å¿ƒWebæŒ‡æ ‡
  getCLS(sendToAnalytics);
  getFID(sendToAnalytics);
  getFCP(sendToAnalytics);
  getLCP(sendToAnalytics);
  getTTFB(sendToAnalytics);
  getINP(sendToAnalytics);  // æ–°çš„äº¤äº’æŒ‡æ ‡
  
  // è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡
  measureResourceLoading();
  measureAPIPerformance();
  measureLongTasks();
}

/**
 * å‘é€æ•°æ®åˆ°åˆ†æå¹³å°
 */
function sendToAnalytics(metric) {
  const body = JSON.stringify({
    name: metric.name,
    value: metric.value,
    rating: metric.rating,  // good, needs-improvement, poor
    delta: metric.delta,
    entries: metric.entries,
    id: metric.id,
    navigationType: metric.navigationType,
    // æ·»åŠ ä¸šåŠ¡ä¸Šä¸‹æ–‡
    page: window.location.pathname,
    timestamp: Date.now(),
    userAgent: navigator.userAgent,
    connection: navigator.connection?.effectiveType
  });
  
  // ä½¿ç”¨sendBeaconç¡®ä¿æ•°æ®å‘é€
  if (navigator.sendBeacon) {
    navigator.sendBeacon('/analytics/performance', body);
  } else {
    fetch('/analytics/performance', {
      method: 'POST',
      body,
      keepalive: true
    });
  }
}

/**
 * èµ„æºåŠ è½½æ€§èƒ½ç›‘æ§
 */
function measureResourceLoading() {
  const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (entry.entryType === 'resource') {
        // åªç›‘æ§å…³é”®èµ„æº
        if (isCriticalResource(entry.name)) {
          console.log('Resource loaded:', {
            name: entry.name,
            duration: entry.duration,
            size: entry.transferSize,
            type: entry.initiatorType
          });
        }
      }
    }
  });
  
  observer.observe({ entryTypes: ['resource'] });
}

/**
 * APIæ€§èƒ½ç›‘æ§
 */
function measureAPIPerformance() {
  const originalFetch = window.fetch;
  
  window.fetch = async function(...args) {
    const start = performance.now();
    const url = args[0];
    
    try {
      const response = await originalFetch.apply(this, args);
      const duration = performance.now() - start;
      
      // ä¸ŠæŠ¥APIæ€§èƒ½
      sendToAnalytics({
        name: 'api-timing',
        value: duration,
        entries: [{ url, status: response.status }]
      });
      
      return response;
    } catch (error) {
      const duration = performance.now() - start;
      
      sendToAnalytics({
        name: 'api-error',
        value: duration,
        entries: [{ url, error: error.message }]
      });
      
      throw error;
    }
  };
}

/**
 * é•¿ä»»åŠ¡ç›‘æ§
 */
function measureLongTasks() {
  if ('PerformanceLongTaskTiming' in window) {
    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        console.warn('Long task detected:', {
          duration: entry.duration,
          startTime: entry.startTime,
          attribution: entry.attribution
        });
      }
    });
    
    observer.observe({ entryTypes: ['longtask'] });
  }
}

function isCriticalResource(url) {
  const criticalPatterns = [
    /critical\.css/,
    /app\.js/,
    /hero\.(jpg|png|webp)/
  ];
  return criticalPatterns.some(pattern => pattern.test(url));
}

/**
 * æ€§èƒ½æ ‡è®°å’Œæµ‹é‡
 */
export function mark(name) {
  performance.mark(name);
}

export function measure(name, startMark, endMark) {
  performance.measure(name, startMark, endMark);
  const entries = performance.getEntriesByName(name);
  return entries[entries.length - 1];
}

// ä½¿ç”¨ç¤ºä¾‹
export function trackPageLoad() {
  mark('page-start');
  
  window.addEventListener('load', () => {
    mark('page-load');
    const measurement = measure('page-load-time', 'page-start', 'page-load');
    console.log('Page load time:', measurement.duration);
  });
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ã€èµ„æºä¼˜åŒ–ã€‘                                                       â”‚
â”‚  â–¡ 1. å¯ç”¨Brotli/Gzipå‹ç¼©                                          â”‚
â”‚  â–¡ 2. å›¾ç‰‡ä½¿ç”¨WebP/AVIFæ ¼å¼                                        â”‚
â”‚  â–¡ 3. å®ç°å“åº”å¼å›¾ç‰‡srcset                                         â”‚
â”‚  â–¡ 4. å›¾ç‰‡æ‡’åŠ è½½loading="lazy"                                     â”‚
â”‚  â–¡ 5. å­—ä½“ä½¿ç”¨woff2æ ¼å¼                                            â”‚
â”‚  â–¡ 6. å†…è”å…³é”®CSS                                                  â”‚
â”‚  â–¡ 7. å¼‚æ­¥åŠ è½½éå…³é”®CSS                                            â”‚
â”‚                                                                     â”‚
â”‚  ã€ä»£ç ä¼˜åŒ–ã€‘                                                       â”‚
â”‚  â–¡ 1. è·¯ç”±çº§ä»£ç åˆ†å‰²                                               â”‚
â”‚  â–¡ 2. ç»„ä»¶çº§æ‡’åŠ è½½                                                 â”‚
â”‚  â–¡ 3. Tree Shakingç§»é™¤æ— ç”¨ä»£ç                                      â”‚
â”‚  â–¡ 4. JS/CSSå‹ç¼©å’Œæ··æ·†                                             â”‚
â”‚  â–¡ 5. ç§»é™¤consoleå’Œdebugger                                        â”‚
â”‚  â–¡ 6. ä½¿ç”¨CDNåŠ è½½ç¬¬ä¸‰æ–¹åº“                                          â”‚
â”‚                                                                     â”‚
â”‚  ã€ç¼“å­˜ç­–ç•¥ã€‘                                                       â”‚
â”‚  â–¡ 1. é™æ€èµ„æºé•¿æœŸç¼“å­˜                                             â”‚
â”‚  â–¡ 2. ä½¿ç”¨æ–‡ä»¶åhash                                               â”‚
â”‚  â–¡ 3. é…ç½®Service Worker                                           â”‚
â”‚  â–¡ 4. ä½¿ç”¨localStorageç¼“å­˜æ•°æ®                                     â”‚
â”‚                                                                     â”‚
â”‚  ã€æ¸²æŸ“ä¼˜åŒ–ã€‘                                                       â”‚
â”‚  â–¡ 1. å‡å°‘DOMèŠ‚ç‚¹æ•°é‡                                              â”‚
â”‚  â–¡ 2. ä½¿ç”¨CSS Containment                                          â”‚
â”‚  â–¡ 3. é¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€                                             â”‚
â”‚  â–¡ 4. ä½¿ç”¨transformä»£æ›¿top/left                                    â”‚
â”‚  â–¡ 5. ä½¿ç”¨will-changeä¼˜åŒ–åŠ¨ç”»                                      â”‚
â”‚  â–¡ 6. è™šæ‹Ÿåˆ—è¡¨å¤„ç†é•¿åˆ—è¡¨                                           â”‚
â”‚                                                                     â”‚
â”‚  ã€ç½‘ç»œä¼˜åŒ–ã€‘                                                       â”‚
â”‚  â–¡ 1. å¯ç”¨HTTP/2æˆ–HTTP/3                                           â”‚
â”‚  â–¡ 2. ä½¿ç”¨DNSé¢„è§£æ                                                â”‚
â”‚  â–¡ 3. ä½¿ç”¨é¢„è¿æ¥                                                   â”‚
â”‚  â–¡ 4. é¢„åŠ è½½å…³é”®èµ„æº                                               â”‚
â”‚  â–¡ 5. ä½¿ç”¨èµ„æºæç¤ºprefetch/prerender                               â”‚
â”‚                                                                     â”‚
â”‚  ã€ç›‘æ§æŒ‡æ ‡ã€‘                                                       â”‚
â”‚  â–¡ 1. LCP < 2.5s                                                   â”‚
â”‚  â–¡ 2. FID/INP < 100ms                                              â”‚
â”‚  â–¡ 3. CLS < 0.1                                                    â”‚
â”‚  â–¡ 4. TTFB < 600ms                                                 â”‚
â”‚  â–¡ 5. Lighthouseè¯„åˆ† > 90                                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸ƒã€ç»éªŒæ€»ç»“

### 7.1 å¸¸è§æ€§èƒ½é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| LCPè¿‡é«˜ | é¦–å±å›¾ç‰‡è¿‡å¤§ | å‹ç¼©å›¾ç‰‡ã€ä½¿ç”¨WebPã€å“åº”å¼å›¾ç‰‡ |
| CLSåç§» | å›¾ç‰‡æ— å°ºå¯¸ | è®¾ç½®width/heightã€ä½¿ç”¨aspect-ratio |
| FIDå»¶è¿Ÿ | ä¸»çº¿ç¨‹é˜»å¡ | ä»£ç åˆ†å‰²ã€Web Workersã€å»¶è¿ŸåŠ è½½ |
| TTFBè¿‡é«˜ | æœåŠ¡ç«¯æ…¢ | å¯ç”¨ç¼“å­˜ã€CDNã€ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ |
| JSä½“ç§¯å¤§ | æœªä»£ç åˆ†å‰² | è·¯ç”±æ‡’åŠ è½½ã€Tree Shaking |
| ç¼“å­˜å¤±æ•ˆ | æ–‡ä»¶åæ— hash | é…ç½®webpack contenthash |

### 7.2 æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  é«˜å½±å“ + ä½æŠ•å…¥             â”‚
              â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
              â”‚  â€¢ å›¾ç‰‡ä¼˜åŒ–ï¼ˆWebP/å‹ç¼©ï¼‰     â”‚
              â”‚  â€¢ å¯ç”¨Gzip/Brotli           â”‚
              â”‚  â€¢ é…ç½®HTTPç¼“å­˜              â”‚
              â”‚  â€¢ å¼‚æ­¥åŠ è½½éå…³é”®JS          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  é«˜å½±å“ + ä¸­ç­‰æŠ•å…¥           â”‚
              â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
              â”‚  â€¢ ä»£ç åˆ†å‰²                  â”‚
              â”‚  â€¢ æ‡’åŠ è½½ç»„ä»¶                â”‚
              â”‚  â€¢ Service Worker            â”‚
              â”‚  â€¢ å…³é”®CSSå†…è”               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ä¸­ç­‰å½±å“ + é«˜æŠ•å…¥           â”‚
              â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
              â”‚  â€¢ SSR/SSG                   â”‚
              â”‚  â€¢ è¾¹ç¼˜è®¡ç®—                  â”‚
              â”‚  â€¢ å¾®å‰ç«¯æ¶æ„                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ç³»åˆ—ä¸Šä¸€ç¯‡**ï¼š[TLS/SSLå®‰å…¨ä¼ è¾“åŸç†ä¸å®è·µ](04TLS_SSLå®‰å…¨ä¼ è¾“åŸç†ä¸å®è·µ.md)

**ç³»åˆ—ä¸‹ä¸€ç¯‡**ï¼š[åç«¯æœåŠ¡ä¼˜åŒ–ç­–ç•¥](06åç«¯æœåŠ¡ä¼˜åŒ–ç­–ç•¥.md)
