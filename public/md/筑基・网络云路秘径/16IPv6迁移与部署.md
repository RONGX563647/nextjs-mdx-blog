# IPv6迁移与部署

## 一、问题引入：IPv4地址枯竭

### 1.1 IPv4的困境

```
IPv4地址枯竭现状：
┌─────────────────────────────────────────────────────────────┐
│ 现状：                                                       │
│ - IPv4地址总数：约43亿                                       │
│ - 全球互联网设备：超过200亿                                  │
│ - NAT成为标配，但带来诸多问题                                │
├─────────────────────────────────────────────────────────────┤
│ NAT的问题：                                                  │
│ - 破坏端到端连接                                             │
│ - 增加网络复杂性                                             │
│ - 影响P2P应用                                                │
│ - 物联网部署困难                                             │
├─────────────────────────────────────────────────────────────┤
│ IPv6优势：                                                   │
│ - 地址空间：2^128（约3.4×10^38）                             │
│ - 简化头部格式                                               │
│ - 内置安全性（IPsec）                                        │
│ - 更好的移动性支持                                           │
│ - 自动配置                                                   │
└─────────────────────────────────────────────────────────────┘
```

## 二、IPv6协议基础

### 2.1 IPv6地址格式

```
IPv6地址表示：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  完整格式：                                                  │
│  2001:0db8:85a3:0000:0000:8a2e:0370:7334                    │
│                                                              │
│  压缩规则：                                                  │
│  - 前导0可省略：2001:db8:85a3:0:0:8a2e:370:7334             │
│  - 连续0块可压缩为::（只能一次）                             │
│  - 2001:db8:85a3::8a2e:370:7334                             │
│                                                              │
│  地址类型：                                                  │
│  - 单播（Unicast）                                           │
│  - 组播（Multicast）：ff00::/8                              │
│  - 任播（Anycast）                                           │
│  - 无广播（Broadcast）                                       │
│                                                              │
│  特殊地址：                                                  │
│  - ::/128：未指定地址                                        │
│  - ::1/128：环回地址                                         │
│  - fe80::/10：链路本地地址                                   │
│  - fc00::/7：唯一本地地址（ULA）                             │
│  - 2000::/3：全球单播地址                                    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 IPv6与IPv4对比

```
协议对比：
┌────────────────────┬──────────────────┬──────────────────┐
│ 特性               │ IPv4             │ IPv6             │
├────────────────────┼──────────────────┼──────────────────┤
│ 地址长度           │ 32位             │ 128位            │
│ 地址数量           │ 约43亿           │ 3.4×10^38        │
│ 头部长度           │ 可变（20-60字节）│ 固定（40字节）   │
│ 校验和             │ 有               │ 无（由上层处理） │
│ NAT                │ 普遍使用         │ 不需要           │
│ 自动配置           │ DHCP             │ SLAAC/DHCPv6     │
│ 安全性             │ IPsec可选        │ IPsec内置        │
│ 移动性             │ 较差             │ 原生支持         │
│ 广播               │ 支持             │ 不支持（用组播） │
└────────────────────┴──────────────────┴──────────────────┘
```

## 三、IPv6过渡技术

### 3.1 双栈（Dual Stack）

```
双栈部署：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  主机/路由器同时运行IPv4和IPv6协议栈                         │
│                                                              │
│  ┌─────────────┐                                            │
│  │  应用层     │                                            │
│  └──────┬──────┘                                            │
│         │                                                    │
│    ┌────┴────┐                                               │
│    ▼         ▼                                               │
│  ┌─────┐  ┌─────┐                                           │
│  │IPv4 │  │IPv6 │                                           │
│  └─────┘  └─────┘                                           │
│                                                              │
│  优点：                                                        │
│  - 最理想的过渡方案                                          │
│  - 应用可逐步迁移                                            │
│                                                              │
│  缺点：                                                        │
│  - 需要更多资源                                              │
│  - 配置复杂                                                  │
│                                                              │
└──────────────────────────────────────────────────────────────┘

Nginx双栈配置：
```nginx
server {
    listen 80;
    listen [::]:80;  # IPv6
    
    listen 443 ssl;
    listen [::]:443 ssl;  # IPv6
    
    server_name example.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
}
```
```

### 3.2 隧道技术

```
隧道技术：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  6to4隧道：                                                  │
│  IPv6包封装在IPv4包中传输                                    │
│  前缀：2002::/16                                            │
│                                                              │
│  Teredo隧道：                                                │
│  穿越NAT的IPv6隧道                                           │
│  前缀：2001::/32                                            │
│                                                              │
│  GRE隧道：                                                   │
│  通用路由封装                                                │
│                                                              │
│  ┌─────────┐      ┌─────────┐      ┌─────────┐             │
│  │IPv6网络 │◄────►│IPv4隧道 │◄────►│IPv6网络 │             │
│  └─────────┘      └─────────┘      └─────────┘             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 3.3 转换技术（NAT64/DNS64）

```
NAT64/DNS64：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  场景：纯IPv6客户端访问IPv4服务器                            │
│                                                              │
│  ┌─────────┐      ┌─────────┐      ┌─────────┐             │
│  │IPv6主机 │◄────►│ NAT64   │◄────►│IPv4主机 │             │
│  └─────────┘      │ 网关    │      └─────────┘             │
│                   └─────────┘                                │
│                                                              │
│  DNS64：合成AAAA记录                                         │
│  - 查询example.com AAAA                                      │
│  - DNS64返回：64:ff9b::1.2.3.4                               │
│  - 前缀64:ff9b::/96是Well-Known前缀                          │
│                                                              │
│  NAT64：地址和协议转换                                       │
│  - 源地址：2001:db8::1                                       │
│  - 目的地址：64:ff9b::1.2.3.4                               │
│  - 转换为IPv4包发送到1.2.3.4                                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 四、IPv6部署实践

### 4.1 网络设备配置

```bash
# Linux启用IPv6
# 1. 检查IPv6支持
cat /proc/net/if_inet6

# 2. 启用IPv6转发
echo "net.ipv6.conf.all.forwarding=1" >> /etc/sysctl.conf
sysctl -p

# 3. 配置静态IPv6地址
ip -6 addr add 2001:db8::1/64 dev eth0

# 4. 配置IPv6路由
ip -6 route add default via 2001:db8::ff

# 5. 配置IPv6防火墙（ip6tables）
ip6tables -A INPUT -p tcp --dport 80 -j ACCEPT
ip6tables -A INPUT -p tcp --dport 443 -j ACCEPT
ip6tables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
ip6tables -P INPUT DROP
```

### 4.2 阿里云IPv6配置

```yaml
# Terraform配置VPC IPv6
resource "alicloud_vpc" "example" {
  vpc_name   = "ipv6-vpc"
  cidr_block = "172.16.0.0/16"
  
  # 启用IPv6
  enable_ipv6 = true
}

resource "alicloud_vswitch" "example" {
  vpc_id       = alicloud_vpc.example.id
  cidr_block   = "172.16.1.0/24"
  zone_id      = "cn-beijing-a"
  
  # IPv6网段
  ipv6_cidr_block_mask = 64
}

# ECS配置IPv6
resource "alicloud_instance" "example" {
  instance_name = "ipv6-ecs"
  
  # 分配IPv6地址
  ipv6_address_count = 1
  
  # 安全组开放IPv6
  security_groups = [alicloud_security_group.ipv6.id]
}

# 安全组规则（IPv6）
resource "alicloud_security_group_rule" "ipv6_http" {
  type              = "ingress"
  ip_protocol       = "tcp"
  nic_type          = "intranet"
  policy            = "accept"
  port_range        = "80/80"
  priority          = 1
  security_group_id = alicloud_security_group.ipv6.id
  ipv6_cidr_ip      = "::/0"  # 允许所有IPv6访问
}
```

### 4.3 应用层适配

```java
/**
 * Java应用IPv6适配
 */
@Component
public class IPv6Support {
    
    /**
     * 监听IPv6地址
     */
    @Bean
    public WebServerFactoryCustomizer<TomcatServletWebServerFactory> tomcatCustomizer() {
        return factory -> {
            factory.addConnectorCustomizers(connector -> {
                // 同时监听IPv4和IPv6
                connector.setProperty("address", "0.0.0.0");
            });
        };
    }
    
    /**
     * 解析IPv6地址
     */
    public boolean isIPv6(String ip) {
        try {
            InetAddress address = InetAddress.getByName(ip);
            return address instanceof Inet6Address;
        } catch (UnknownHostException e) {
            return false;
        }
    }
    
    /**
     * 格式化IPv6地址用于日志
     */
    public String formatIPv6(String ip) {
        try {
            Inet6Address address = (Inet6Address) Inet6Address.getByName(ip);
            return address.getHostAddress();
        } catch (UnknownHostException e) {
            return ip;
        }
    }
}
```

## 五、IPv6安全考虑

```
IPv6安全要点：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  1. 防火墙规则                                               │
│  - 需要单独配置IPv6防火墙（ip6tables/nftables）              │
│  - 不要只依赖IPv4防火墙                                      │
│                                                              │
│  2. 扩展头部安全                                             │
│  - IPv6使用扩展头部，可能被用于攻击                          │
│  - 需要检查和过滤异常扩展头部                                │
│                                                              │
│  3. ICMPv6                                                   │
│  - ICMPv6对IPv6运行至关重要（邻居发现）                      │
│  - 不能简单阻止所有ICMPv6                                    │
│                                                              │
│  4. 地址扫描                                                 │
│  - IPv6地址空间大，扫描困难                                  │
│  - 但仍需防御（如基于DNS的扫描）                             │
│                                                              │
│  5. 双栈安全                                                 │
│  - 确保IPv4和IPv6安全策略一致                                │
│  - 防止通过一种协议绕过另一种的安全控制                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 六、IPv6迁移步骤

```
迁移路线图：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  阶段1：准备（1-3个月）                                      │
│  □ 评估现有网络设备和应用IPv6支持                            │
│  □ 制定IPv6地址规划                                          │
│  □ 培训技术团队                                              │
│                                                              │
│  阶段2：基础设施（3-6个月）                                  │
│  □ 核心网络启用IPv6（双栈）                                  │
│  □ 配置IPv6路由和安全策略                                    │
│  □ 部署IPv6 DNS                                              │
│                                                              │
│  阶段3：应用迁移（6-12个月）                                 │
│  □ 应用代码IPv6适配                                          │
│  □ 测试和验证                                                │
│  □ 逐步上线                                                  │
│                                                              │
│  阶段4：优化（持续）                                         │
│  □ 监控IPv6流量                                              │
│  □ 性能优化                                                  │
│  □ 考虑关闭IPv4（长期目标）                                  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 七、IPv6监控

```bash
#!/bin/bash
# IPv6监控脚本

# 检查IPv6连接
if ! ping6 -c 1 2001:4860:4860::8888 &> /dev/null; then
    echo "ALERT: IPv6 connectivity issue"
    # 发送告警
fi

# 监控IPv6流量
ipv6_rx=$(cat /proc/net/dev | grep eth0 | awk '{print $3}')
ipv6_tx=$(cat /proc/net/dev | grep eth0 | awk '{print $11}')

echo "IPv6 RX: $ipv6_rx bytes"
echo "IPv6 TX: $ipv6_tx bytes"

# 检查IPv6邻居表
ip -6 neigh show | wc -l
echo "IPv6 neighbors: $(ip -6 neigh show | wc -l)"
```

---

**系列上一篇**：[网络可观测性建设](15网络可观测性建设.md)

**系列完结**
